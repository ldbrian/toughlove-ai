
-----

# 🛠️ 透 · TOUGH 开发技术手册 (Development Manual)

**Version:** v2.3.0 "The Mirror"
**Last Updated:** 2025-12-03
**Scope:** Architecture, Modules, Protocols, and Standards

-----

## 1\. 技术架构总览 (Architecture Overview)

### 1.1 技术栈 (Tech Stack)

  * **Framework**: Next.js 14 (App Router)
  * **Language**: TypeScript (Strict Mode)
  * **UI System**: Tailwind CSS + Lucide React (Icons)
  * **AI Engine**: Vercel AI SDK (`useChat` stream protocol)
  * **State Management**: React Local State (`useState`) + LocalStorage (Persistence)
      * *注意：本项目目前采用“状态提升”策略，`page.tsx` 作为上帝组件持有所有全局状态。*
  * **Tools**:
      * `html2canvas`: 用于生成病毒海报 (Viral Poster)。
      * `posthog-js`: 用于埋点分析。

### 1.2 目录结构 (Directory Structure)

```text
/src
  ├── app/
  │   ├── api/             # 后端 API 路由
  │   │   ├── chat/        # LLM 核心对话流
  │   │   ├── tts/         # 语音合成服务
  │   │   ├── wallet/      # 积分/钱包同步
  │   │   └── sync/        # 聊天记录云同步
  │   └── page.tsx         # [核心] 客户端主入口，承载所有业务逻辑
  ├── components/
  │   ├── features/        # 功能组件 (FocusOverlay, StickyNote)
  │   ├── modals/          # 弹窗组件 (Onboarding, Shop, Profile...)
  │   └── ui/              # 基础 UI (Typewriter, BootScreen)
  ├── lib/
  │   ├── constants.ts     # [核心] 静态配置 (Persona, Tarot, Questions)
  │   ├── utils.ts         # 通用工具函数
  │   ├── storage.ts       # 本地存储封装
  │   └── env.ts           # 环境/时间检测
  └── public/              # 静态资源 (Avatars, Wallpapers)
```

-----

## 2\. 核心功能模块规范 (Functional Modules)

### 2.1 状态机与人格系统 (Persona System)

  * **逻辑文件**: `constants.ts` (配置), `page.tsx` (切换逻辑)
  * **状态保持**:
      * `activePersona`: 控制当前 UI 主题、对话上下文。
      * `messages`: 聊天记录，通过 `getMemory/saveMemory` 同步至 LocalStorage。
  * **开发红线**: **禁止**在组件内部硬编码人格名称字符串，必须使用 `PersonaType` 类型及 `PERSONAS` 常量。

### 2.2 诊断系统 (Onboarding Module)

  * **组件**: `OnboardingModal.tsx`
  * **流程**:
    1.  **L0 (Fuzzy Scan)**: 5道题 -\> 计算维度分 -\> 若放弃深度同步 -\> 生成**模糊画像** (无雷达图，Data Corrupt UI)。
    2.  **L1 (Deep Sync)**: 追加5道题 -\> 重新计算 -\> 生成**完整画像** (雷达图，ID生成)。
  * **关键逻辑**:
      * **ID 生成**: 必须在 `useEffect` 中生成随机 ID，严禁在 Server Side 渲染随机数（防止 Hydration Error）。
      * **结束回调**: `onFinish` 必须先销毁 Modal 组件，再触发主界面的后续逻辑（如 Daily Briefing），需加 `setTimeout` 缓冲。

### 2.3 专注监管系统 (Sol Focus Protocol)

  * **组件**: `FocusOverlay.tsx` + `page.tsx` (逻辑)
  * **核心变量**: `isFocusActive` (开关), `focusRemaining` (剩余秒数), `isFocusPaused` (暂停).
  * **计时器逻辑**:
      * 必须使用 `useEffect` 监听 `isFocusActive` 且建立 `setInterval`。
      * 每秒更新 State 并同步写入 `localStorage` (防止刷新丢失进度)。
  * **放弃惩罚**:
      * 触发放弃 -\> 计算已进行时间 -\> 写入 `shameData` -\> **先关闭 Focus 状态** -\> **延时开启 Shame Modal**。

### 2.4 能量补给系统 (Rin Station)

  * **组件**: `StickyNoteOverlay.tsx`
  * **触发**: 关键词拦截 or AI 指令。
  * **任务库**: 定义在 `constants.ts` 的 `RIN_TASKS`。
  * **结算**: 完成任务 -\> API `/api/event` 上报 -\> 本地 Wallet +50 -\> 触发 Glory Modal。

### 2.5 经济与商店系统 (Economy)

  * **货币**: `userRin` (State) \<-\> `toughlove_rin_balance` (LocalStorage)。
  * **商品逻辑**:
      * `constants.ts` 定义 `SHOP_CATALOG`。
      * **Effect 映射**:
          * `ASH_MOOD_SOFT`: 注入 System Prompt Buff。
          * `BG_...`: 修改 `wallpapers` State 映射。
          * `REMOVE_SHAME`: 调用 API 清除历史耻辱记录。

-----

## 3\. 接口与协议规范 (Interfaces & Protocols)

### 3.1 隐式指令协议 (Command Protocol)

这是系统自动化的核心，连接 AI 意图与前端逻辑。

| 类型 | 指令格式 | 发送方 | 接收方 | 触发行为 |
| :--- | :--- | :--- | :--- | :--- |
| **Offer Focus** | `[CMD:FOCUS_OFFER]` | AI (Sol) | Client | 弹出专注模式建议弹窗 |
| **Offer Task** | `[CMD:RIN_OFFER]` | AI (Rin) | Client | 弹出便利贴任务 |
| **User Key** | "focus" / "专注" | User Input | Client | **拦截发送**，直接开启专注引导 |
| **User Key** | "task" / "便利贴" | User Input | Client | **拦截发送**，直接开启任务抽取 |

**开发规范**: 修改 `handleSubmit` 或 `useChat` 回调时，必须保留上述正则匹配逻辑。

### 3.2 数据持久化键值 (LocalStorage Schema)

为了避免 Key 冲突，所有键名必须遵循 `toughlove_[module]_[feature]` 格式。

| Key | Value Type | 描述 |
| :--- | :--- | :--- |
| `toughlove_user_profile` | JSON Object | 用户画像 (Radar, Tags, Dominant Persona) |
| `toughlove_rin_balance` | Number (Int) | 用户当前代币余额 |
| `toughlove_focus_active` | Boolean String | 是否处于专注模式中 |
| `toughlove_focus_remaining`| Number String | 专注倒计时剩余秒数 |
| `toughlove_focus_start_time`| Timestamp | 专注开始时间 (用于计算放弃时长) |
| `toughlove_has_seen_shop` | Boolean String | 是否已解锁商店 (控制红点) |
| `toughlove_trust_[persona]`| Number String | 与特定人格的交互次数 (信任等级) |

-----

## 4\. UI/UX 开发准则 (UI Guidelines)

### 4.1 弹窗渲染守则 (Modal Rendering)

**Golden Rule: Data First, Visibility Second.**

  * ❌ **错误**: `setShowModal(true)` -\> `fetchData()` -\> `setData()` (导致闪烁/空内容)。
  * ✅ **正确**: `prepareData()` -\> `setModalData()` -\> `setTimeout(() => setShowModal(true), 50)`。

### 4.2 海报生成规范 (Viral Poster)

  * **组件**: `ViralPoster`
  * **限制**: 该组件在屏幕可视区域外 (`left: -9999px`) 渲染。
  * **Hydration**: 内部的 ID、日期、随机数必须在 `useEffect` 中赋值，禁止直接在 JSX 中使用 `Math.random()`，否则会导致服务端与客户端 HTML 不匹配。
  * **CORS**: 涉及跨域图片（如头像、背景），必须配置 `crossOrigin="anonymous"` 且服务器需支持 CORS，否则 `html2canvas` 会生成空白图片。

### 4.3 样式风格 (Styling)

  * **Glassmorphism**: 使用 `backdrop-blur-md bg-white/5 border-white/10` 构建层级。
  * **Typography**: 主要使用 `font-sans`，数字/ID 使用 `font-mono`。
  * **Safe Area**: 底部交互区必须包含 `pb-[calc(1rem+env(safe-area-inset-bottom))]` 以适配 iOS。

-----

## 5\. 防退化检查清单 (Anti-Regression Checklist)

在每次提交代码前，必须核对以下关键点，防止功能回退：

1.  **[Core]** `page.tsx` 中的 `setInterval` 是否存在？是否会被闭包陷阱卡住？
2.  **[Flow]** Onboarding 结束后，是否正确关闭了 Modal 并写入了 LocalStorage？
3.  **[Data]** `constants.ts` 中的 `SHOP_CATALOG` 和 `TAROT_DECK` 是否完整（非空数组）？
4.  **[UX]** 点击“放弃专注”时，是否先有了 `shameData` 才弹窗？
5.  **[Logic]** 输入 "专注" 时，是否拦截了请求，没有浪费 Token 发送给 LLM？

-----
